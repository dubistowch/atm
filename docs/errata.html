<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‹˜èª¤ç´€éŒ„ - ATMon å°‹æ˜Ÿä¹‹å¤¢</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-brand">å°‹æ˜Ÿä¹‹å¤¢ <span>ATMon</span></a>

      <button class="nav-toggle" type="button" aria-label="é–‹å•Ÿé¸å–®" aria-expanded="false" onclick="toggleNavMenu()">â˜°</button>

      <div class="nav-links" id="nav-links">
        <a href="index.html" class="nav-item">ğŸ“– å†’éšªæŒ‡å—</a>
        <a href="controls.html" class="nav-item">âŒ¨ï¸ æŒ‰éµå°ç…§</a>
        <a href="mods.html" class="nav-item">ğŸ“¦ æ¨¡çµ„ç™¾ç§‘</a>
        <a href="errata.html" class="nav-item active">ğŸ§¾ å‹˜èª¤ç´€éŒ„</a>
      </div>
    </div>
  </nav>

  <a class="report-btn" id="report-btn" href="https://n8n.dubi.app/form/6e15be41-ae88-4e0d-9241-09d3d418e2f8" target="_blank" rel="noopener noreferrer" title="å›å ±éŒ¯èª¤">ğŸ› å›å ±éŒ¯èª¤</a>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">å‹˜èª¤ç´€éŒ„</h1>
      <p class="page-subtitle">ç©å®¶å›å ± â†’ ä¿®æ­£è¿½è¹¤ï¼ˆä»¥èŠå¤©è¨Šæ¯å½¢å¼å‘ˆç¾ï¼‰</p>
    </div>

    <div class="chat-toolbar">
      <div class="chat-hint">æç¤ºï¼šé»ã€ŒğŸ› å›å ±éŒ¯èª¤ã€å¯æäº¤å•é¡Œï¼›é€™è£¡æœƒæŠŠå·²è™•ç†/å¾…è™•ç†äº‹é …æ•´ç†æˆç´€éŒ„ã€‚</div>
      <div class="chat-filters">
        <button class="filter-btn active" onclick="setStatusFilter('all')">å…¨éƒ¨</button>
        <button class="filter-btn" onclick="setStatusFilter('open')">æœªè™•ç†</button>
        <button class="filter-btn" onclick="setStatusFilter('fixed')">å·²ä¿®æ­£</button>
      </div>
    </div>

    <div id="errata-list" class="chat-list">
      <div class="loading">æ­£åœ¨è®€å–å‹˜èª¤ç´€éŒ„...</div>
    </div>
  </div>

  <script>
    let allItems = [];
    let statusFilter = 'all';

    function escapeHtml(s) {
      return (s || '').replace(/[&<>\"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function setActiveButtons(containerEl, activeEl) {
      containerEl.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if (activeEl) activeEl.classList.add('active');
    }

    function setStatusFilter(v) {
      statusFilter = v;
      setActiveButtons(document.querySelector('.chat-filters'), event.target);
      render();
    }

    function fmtTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString('zh-Hant', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      } catch (e) {
        return iso || '';
      }
    }

    function badge(status) {
      const s = (status || 'open').toLowerCase();
      const map = {
        open: { text: 'æœªè™•ç†', cls: 'status-open' },
        fixed: { text: 'å·²ä¿®æ­£', cls: 'status-fixed' },
        wip: { text: 'è™•ç†ä¸­', cls: 'status-wip' },
      };
      const b = map[s] || { text: escapeHtml(status || 'open'), cls: 'status-open' };
      return `<span class="status-badge ${b.cls}">${b.text}</span>`;
    }

    function render() {
      const root = document.getElementById('errata-list');
      const items = allItems
        .filter(it => statusFilter === 'all' || (it.status || 'open').toLowerCase() === statusFilter)
        .sort((a,b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

      if (items.length === 0) {
        root.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„ã€‚</div>';
        return;
      }

      root.innerHTML = items.map(it => {
        const page = it.page ? `<a class="chat-meta-link" href="index.html?guide=${encodeURIComponent(it.page)}">æŸ¥çœ‹ç›¸é—œæ–‡ç« </a>` : '';
        return `
          <div class="chat-card">
            <div class="chat-meta">
              <div class="chat-meta-left">
                ${badge(it.status)}
                <span class="chat-time">${escapeHtml(fmtTime(it.createdAt))}</span>
              </div>
              <div class="chat-meta-right">
                ${page}
              </div>
            </div>

            <div class="chat-bubble chat-user">
              <div class="chat-name">${escapeHtml(it.user?.name || 'ç©å®¶')}</div>
              <div class="chat-msg">${escapeHtml(it.user?.message || '')}</div>
            </div>

            <div class="chat-bubble chat-ai">
              <div class="chat-name">${escapeHtml(it.ai?.name || 'BearClaw')}</div>
              <div class="chat-msg">${escapeHtml(it.ai?.message || '')}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleNavMenu() {
      const links = document.getElementById('nav-links');
      const btn = document.querySelector('.nav-toggle');
      if (!links || !btn) return;
      const open = links.classList.toggle('open');
      btn.setAttribute('aria-expanded', open ? 'true' : 'false');
    }

    async function init() {
      try {
        const res = await fetch('./errata.json');
        if (!res.ok) throw new Error('failed');
        allItems = await res.json();
      } catch (e) {
        allItems = [];
      }
      render();
    }

    function updateReportBtn() {
      const a = document.getElementById('report-btn');
      if (!a) return;
      const base = 'https://n8n.dubi.app/form/6e15be41-ae88-4e0d-9241-09d3d418e2f8';
      const u = new URL(base);
      u.searchParams.set('ç¶²å€', window.location.href);
      u.searchParams.set('url', window.location.href);
      a.href = u.toString();
    }

    init();
    updateReportBtn();
  </script>
</body>
</html>
